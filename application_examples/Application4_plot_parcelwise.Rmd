---
title: "Application example 4"
author: "Ting Xu (github: tingsterx/reliability_explorer)"
date: "2022-07-08"
output: github_document
---

### Examine the reliability and individual varition between pipelines with global signal regression (GSR) and without GSR

This application example compares the reliability and individual varition across four conventional fMRI pipelines including [fMRIPrep](https://fmriprep.org/en/stable/), [ABCD](https://www.biorxiv.org/content/10.1101/2021.07.09.451638v1), [CCS](https://www.sciencedirect.com/science/article/abs/pii/S2095927316305394) and [C-PAC](https://fcp-indi.github.io/docs/latest/user/index) default. The details are described in [Li et al., 2019](https://www.biorxiv.org/content/10.1101/2021.12.01.470790v1)

Raw data: Consortium for Reliability and Reproducibility (CoRR) - [HNU dataset]( http://fcon_1000.projects.nitrc.org/indi/CoRR/html/hnu_1.html)

**Calculation using ReX**: The individual variation, ICC for each edge (i.e. connectivity), and dbICC at the parcel and whole connectivity level are calcualted using the code: icc_HNU_edgewise_ICC_*.R, icc_HNU_parcelwise_dbICC_*.R, icc_HNU_AllConn_dbICC_*.R


```{r load library, include=TRUE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(rstudioapi)
library(ReX)
library(ggplot2)
library(data.table)
library(dplyr)
library(ggseg)
library(ggsegSchaefer)
```

### Set path
```{r set_path}
setwd(dirname(getSourceEditorContext()$path))
source('func_plot_brain_matrix.R')
data_dir <- file.path('Application3-5', 'results_cpac_HNU', 'ROI_Schaefer200', 'rex_dbICC_per_parcel')
out_dir <- file.path('Application3-5', 'results_cpac_HNU', 'ROI_Schaefer200', 'rex_dbICC_per_parcel_plot')
```

### compare parcelwise dbICC of GSR vs noGSR across pipelines - 10min
```{r}
fname <- paste0(data_dir, "/dbICC_parcelwise_pipelines_10min.csv")
df <- fread(fname)
df <- df %>% dplyr::rename("sigma2_w"="var_w")
df <- df %>% dplyr::rename("sigma2_b"="var_b")

df %>% group_by(pipeline) %>% summarize(mean = mean(dbICC), std = sd(dbICC))

p <- rex_plot.var.field.n(df, group.name = "pipeline", size.point = 2, color.brewer.pla = "Paired",
                          plot.density=FALSE, show.contour = FALSE, color.point.border = NULL, axis.max=10)
p
fname <- sprintf('%s/GSR-NOGSR_10min_All-pipelines_parcelwise_fieldmap.png', out_dir)
ggsave(fname, device="png")
```

### compare parcelwise dbICC of GSR vs noGSR across pipelines - 30min
```{r}
fname <- paste0(data_dir, "/dbICC_parcelwise_pipelines_30min.csv")
df <- fread(fname)
df <- df %>% dplyr::rename("sigma2_w"="var_w")
df <- df %>% dplyr::rename("sigma2_b"="var_b")

df %>% group_by(pipeline) %>% summarize(mean = mean(dbICC), std = sd(dbICC))

p <- rex_plot.var.field.n(df, group.name = "pipeline", size.point = 2, color.brewer.pla = "Paired",
                          plot.density=FALSE, show.contour = FALSE, color.point.border = NULL)
p
fname <- sprintf('%s/GSR-NOGSR_30min_All-pipelines_parcelwise_fieldmap.png', out_dir)
ggsave(fname, device="png")
```

### Comparing pipeline with GSR and without GSR for each of four pipelines (fMRIprep, CCS, ABCD, CPAC) - parcelwise
```{r}
cmap = ReX::rgb2hex(ReX::colormap.gradient.flow())
atlas <- schaefer7_200$data
labels <- read.table(file.path('Application3-5', 'atlas', 'Schaefer2018_200Parcels_7Networks_labels_MatchedTo_ggseg.txt'), header = TRUE)[,1]

pipeline_list <- c("cpac_default_all", "cpac_fmriprep_all", "cpac_ccs_all", "cpac_abcd_all")

for (amount in c("10min", "30min")){
  fname <- paste0(data_dir, "/dbICC_parcelwise_pipeines_comp_", amount, ".csv")
  df_all <- fread(fname)
  
  for (pipeline in pipeline_list){
    prefix <- sprintf('%s_gsr__CompTo__%s', pipeline, pipeline)
  
    df <- df_all %>% filter(contrast == prefix)
    df4ggseg <-  tibble(region = labels, data=df$delta.theta_norm)
    
    p <- df4ggseg %>% 
    ggseg(mapping = aes(fill = data), atlas=schaefer7_200, position="stacked") +
      scale_fill_gradientn(colours = cmap, limits= c(0, 2*pi)) +
      guides(fill = guide_colorbar(barheight=5)) +
      labs(fill = "normalized changes") + annotate(geom="text",label=NULL)
    print(sprintf('%s: %s', amount, prefix))
    print(p)
    fname <- sprintf('%s/GSR-NOGSR_%s_%s_parcelwise.png', out_dir, amount, prefix)
    ggsave(fname, device="png")
      
  }
  
}
```
