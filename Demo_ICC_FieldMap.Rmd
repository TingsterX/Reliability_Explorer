---
title: " "
output: html_document
---

### Individual Variation Field Map and ICC

```{r source, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
files.sources <- paste("reliability", list.files('reliability'), sep=.Platform$file.sep)
invisible(sapply(files.sources, source))
```

```{r setup, include=FALSE}
if (!require(lme4)) install.packages("lme4")
if (!require(R.matlab)) install.packages("R.matlab")
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(plotly)) install.packages("plotly")
library(plotly)
```

```{r, echo=FALSE}
subplot_hide_layout_warning <- function(...) {
  plot <- subplot(...)
  plot$x$layout <- plot$x$layout[grep('NA', names(plot$x$layout), invert = TRUE)]
  plot
}
```


```{r define colormap, echo=FALSE}
cmap_icc_list <- list(c(0, '#7b1c43'), c(0.1, '#7b1c43'), c(0.2, '#43435f'), c(0.3, "#5e5f91"), c(0.4, "#9493c8"), c(0.5, "#64bc46"), c(0.6, "#54b24c"), c(0.7, "#f6eb2b"), c(0.8, "#f5a829"), c(0.9, "#f07e27"), c(1, "#ec3625"))

cmap_icc_list <- list(c(0, '#7b1c43'),  c(0.2, '#43435f'), c(0.3, "#5e5f91"), c(0.4, "#9493c8"), c(0.5, "#64bc46"), c(0.6, "#54b24c"), c(0.7, "#f6eb2b"), c(0.8, "#f5a829"), c(0.9, "#f07e27"), c(1, "#ec3625"), c(1, "#ec3625"))

cmap_icc_list <- list(c(0, '#7a0842'),  c(0.2, '#483f62'), c(0.3, "#625c94"), c(0.4, "#868cb7"), c(0.5, "#54b34d"), c(0.6, "#75e342"), c(0.7, "#e6e407"), c(0.8, "#faa802"), c(0.9, "#fa7202"), c(1, "#fa0c03"), c(1, "#fa0c03"))
```

----

#### Individual Variation Space
- x-axis: within-individual variation
- y-axis: between-individual variation
- z-axis: ICC (intraclass correlation)
- Note: between-individual variation (y-axis) is the "true" between-individual variation separated from the observed individual variation

----

#### Theoretical Variation Field Map (3D)

```{r, out.width="100%", echo=FALSE}
# ICC field map - surface plot
demo1.sigma2_w <- seq(0,1,length=101)
demo1.sigma2_b <- seq(0,1,length=101)
m <- pracma::meshgrid(demo1.sigma2_w, y=demo1.sigma2_b)
xx <- m$X; yy <- m$Y
demo1.icc <- yy/(yy+xx)

p1 <- plot_ly(width = 500, height = 500) %>% 
  add_surface(x = ~demo1.sigma2_w,y = ~demo1.sigma2_b, z = ~demo1.icc,
              colorscale = cmap_icc_list,
              cauto = F, cmin = 0, cmax = 1,
              showscale = FALSE) %>% 
  layout(
    scene = list(xaxis = list(title = 'within-individual variation'),
                 yaxis = list(title = 'between-individual variation'),
                 zaxis = list(title = 'ICC'),
                 camera = list(eye = list(x = 2, y = -2, z = 1))),
    annotations = list(x = 0, y = 1,
                       text = '', 
                       xref = 'paper', yref = 'paper', showarrow = FALSE)
  ) %>%
  colorbar(len = 1)
p1
```
#### Theoretical Variation Field Map (3D)

```{r, out.width="100%", echo=FALSE}
# ICC field map - scatter
m <- pracma::meshgrid(seq(0,1,length=21),y=seq(0,1,length=21))
sigma2_w <- m$X
sigma2_b <- m$Y
icc <- sigma2_b/(sigma2_b+sigma2_w)
tmp <- which(is.nan(icc))
df.demo1 <- data.frame(sigma2_b = sigma2_b[-tmp], sigma2_w = sigma2_w[-tmp], icc=icc[-tmp])

p2 <- plot_ly(width = 500, height = 500) %>% 
  add_markers(x = ~df.demo1$sigma2_w,y = ~df.demo1$sigma2_b, z = ~df.demo1$icc,
        marker = list(size = 4, color = ~df.demo1$icc,
                      colorscale = cmap_icc_list,
                      cauto = F, cmin = 0, cmax = 1,
                      showscale = FALSE)) %>% 
  layout(
    scene = list(xaxis = list(title = 'within-individual variation'),
                 yaxis = list(title = 'between-individual variation'),
                 zaxis = list(title = 'ICC'),
                 camera = list(eye = list(x = 2, y = -2, z = 1))),
    annotations = list(x = 0, y = 1,
                       text = '', 
                       xref = 'paper', yref = 'paper', showarrow = FALSE)
  ) 
p2
```

#### Theoretical Individual Variation Field (2D)
- x-axis: within-individual variation
- y-axis: between-individual variation 

```{r, echo=FALSE}
cmap_icc_list <- list(c(0, '#7a0842'), c(0.05, '#7a0842'),  c(0.15, '#483f62'), c(0.25, "#625c94"), c(0.35, "#868cb7"), c(0.45, "#54b34d"), c(0.55, "#75e342"), c(0.65, "#e6e407"), c(0.75, "#faa802"), c(0.85, "#fa7202"), c(0.95, "#fa0c03"), c(1, "#fa0c03"))

demo1.sigma2_w <- seq(0.01,0.99,length=101)
demo1.sigma2_b <- seq(0.01,0.99,length=101)
m <- pracma::meshgrid(demo1.sigma2_w, y=demo1.sigma2_b)
xx <- m$X; yy <- m$Y
demo1.icc <- yy/(yy+xx)


m <- pracma::meshgrid(seq(0,1,length=21),y=seq(0,1,length=21))
sigma2_w <- m$X
sigma2_b <- m$Y
icc <- sigma2_b/(sigma2_b+sigma2_w)
tmp <- which(is.nan(icc))
df.demo1 <- data.frame(sigma2_b = sigma2_b[-tmp], sigma2_w = sigma2_w[-tmp], icc=icc[-tmp])

```

```{r, out.width="100%", echo=FALSE}
p1 <- plot_ly(width = 800, height = 400) %>%
  add_trace(x = demo1.sigma2_w, y = demo1.sigma2_b, z = demo1.icc, 
            type = "contour" , 
            colorscale = cmap_icc_list, zmin = 0, zmax = 1, showscale = FALSE) %>%
layout(
    xaxis = list(title = 'within-individual variation', range=c(0,1)),
    yaxis = list(title = 'between-individual variation', range=c(0,1),
                 scaleanchor="x", scaleratio=1),
    scene = list(xaxis = list(title = 'within-individual variation', range=c(0,1)),
                 yaxis = list(title = 'between-individual variation', range=c(0,1)))
  )


p2 <- plot_ly(width = 800, height = 400) %>%
  add_markers(data=df.demo1, x = ~sigma2_w, y = ~sigma2_b, 
            type = "scatter" ,  showlegend = FALSE,
            marker = list( color = ~icc, colorscale = cmap_icc_list, cmin = 0, cmax = 1, showscale = FALSE)) %>%
layout(
    xaxis = list(title = 'within-individual variation', range=c(0,1)),
    yaxis = list(title = 'between-individual variation', range=c(0,1),
                 scaleanchor="x", scaleratio=1),
    scene = list(xaxis = list(title = 'within-individual variation', range=c(0,1)),
                 yaxis = list(title = 'between-individual variation', range=c(0,1)))
  )
subplot(p1, p2, shareY = TRUE, titleX = TRUE) 
```

ICC colormap: ![](www/ICC_colormap.png){ width=30% }

